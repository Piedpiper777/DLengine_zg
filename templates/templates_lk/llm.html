{% extends "templates_lk/base.html" %}

{% block styles %}
{{ super() }} 

<!-- ä½¿ç”¨æ›´ç¨³å®šçš„CDNï¼Œå¹¶æ·»åŠ å¤‡ç”¨æ–¹æ¡ˆ -->
<script src="https://unpkg.com/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
<script>
// å¤‡ç”¨CDNåŠ è½½
if (typeof markdownit === 'undefined') {
    console.warn('âš ï¸ ä¸»CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js';
    script.onload = function() {
        console.log('âœ… å¤‡ç”¨CDNåŠ è½½æˆåŠŸ');
        // é‡æ–°åˆå§‹åŒ–markdownè§£æå™¨
        if (typeof markdownit !== 'undefined') {
            md = markdownit({
                html: false,
                xhtmlOut: false,
                breaks: true,
                linkify: true,
                typographer: true
            });
            console.log('âœ… Markdownè§£æå™¨é‡æ–°åˆå§‹åŒ–å®Œæˆ');
        }
    };
    script.onerror = function() {
        console.warn('âš ï¸ å¤‡ç”¨CDNä¹ŸåŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨åŸºç¡€Markdownå¤„ç†');
    };
    document.head.appendChild(script);
}
</script>

<style>
    .chat-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.1);
        overflow: hidden;
        height: calc(100vh - 180px);
        display: flex;
        flex-direction: column;
    }
    
    /* é¡¶éƒ¨å¤´éƒ¨åŒºåŸŸ */
    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
    }
    
    .chat-title {
        font-size: 24px;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .chat-controls {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .conversations-toggle {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .conversations-toggle:hover {
        background: rgba(255,255,255,0.3);
    }
    
    .new-chat-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .new-chat-btn:hover:not(:disabled) {
        background: rgba(255,255,255,0.3);
    }
    
    .new-chat-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* ä¸»è¦å†…å®¹åŒºåŸŸ */
    .chat-main {
        flex: 1;
        display: flex;
        position: relative;
        min-height: 0; /* ç¡®ä¿flexå­å…ƒç´ å¯ä»¥ç¼©å° */
    }
    
    /* å¯¹è¯åˆ—è¡¨ä¾§è¾¹æ  */
    .conversations-sidebar {
        width: 320px;
        background: #f8fafc;
        border-right: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        z-index: 10;
        transform: translateX(-100%);
    }
    
    .conversations-sidebar.open {
        transform: translateX(0);
    }
    
    .conversations-header {
        padding: 16px;
        border-bottom: 1px solid #e2e8f0;
        background: white;
        flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
    }
    
    .conversations-search {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        outline: none;
        box-sizing: border-box;
    }
    
    .conversations-search:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .conversations-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
        min-height: 0; /* å…è®¸æ»šåŠ¨ */
    }
    
    .conversation-item {
        padding: 12px;
        margin: 4px 0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        background: white;
        position: relative;
    }
    
    .conversation-item:hover {
        background: #f1f5f9;
        border-color: #e2e8f0;
    }
    
    .conversation-item.active {
        background: #eff6ff;
        border-color: #3b82f6;
    }
    
    .conversation-content {
        width: 100%;
    }
    
    .conversation-title {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 4px;
        color: #1f2937;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .conversation-preview {
        font-size: 12px;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .conversation-date {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .conversation-date:before {
        content: 'ğŸ•’';
        font-size: 10px;
        opacity: 0.8;
    }
    
    .conversation-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .conversation-item:hover .conversation-actions {
        opacity: 1;
    }
    
    .delete-btn {
        background: #ef4444;
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .delete-btn:hover {
        background: #dc2626;
        transform: scale(1.1);
    }
    
    /* èŠå¤©åŒºåŸŸ */
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fafafa;
        transition: all 0.3s ease;
        min-height: 0; /* ç¡®ä¿flexå­å…ƒç´ å¯ä»¥ç¼©å° */
    }
    
    .conversations-sidebar.open + .chat-area {
        margin-left: 320px;
    }
    
    .messages-container {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 24px;
        background: #fafafa;
        scroll-behavior: smooth;
        min-height: 0; /* å…³é”®ï¼šå…è®¸å®¹å™¨ç¼©å° */
    }
    
    /* è¾“å…¥åŒºåŸŸ - å›ºå®šé«˜åº¦ï¼Œé˜²æ­¢è¢«å‹ç¼© */
    .input-area {
        padding: 20px 24px;
        background: white;
        border-top: 1px solid #e5e7eb;
        flex-shrink: 0; /* é˜²æ­¢è¾“å…¥åŒºåŸŸè¢«å‹ç¼© */
        min-height: 100px; /* ç¡®ä¿è¾“å…¥åŒºåŸŸæœ‰è¶³å¤Ÿçš„æœ€å°é«˜åº¦ */
    }
    
    .input-container {
        max-width: 800px;
        margin: 0 auto;
        position: relative;
        background: #f8fafc;
        border-radius: 16px;
        border: 2px solid #e2e8f0;
        transition: all 0.2s;
        min-height: 60px; /* ç¡®ä¿å®¹å™¨æœ‰æœ€å°é«˜åº¦ */
    }
    
    .input-container:focus-within {
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }
    
    .message-input {
        width: 100%;
        min-height: 50px;
        max-height: 200px;
        padding: 15px 60px 15px 20px;
        border: none;
        background: transparent;
        font-size: 16px;
        line-height: 1.5;
        resize: none;
        outline: none;
        font-family: inherit;
        box-sizing: border-box; /* ç¡®ä¿paddingè¢«æ­£ç¡®è®¡ç®— */
    }
    
    .message-input::placeholder {
        color: #9ca3af;
    }
    
    .send-btn {
        position: absolute;
        right: 8px;
        bottom: 8px;
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
    }
    
    .send-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .send-btn:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    /* è¾“å…¥æŒ‡ç¤ºå™¨ */
    .typing-indicator {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 20px;
        animation: slideIn 0.3s ease;
    }
    
    .typing-indicator .message-avatar {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .typing-content {
        padding: 16px 20px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    
    .typing-dots {
        display: flex;
        gap: 4px;
    }
    
    .typing-dot {
        width: 8px;
        height: 8px;
        background: #9ca3af;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        color: #6b7280;
        padding: 60px 40px;
        min-height: 400px;
    }
    
    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .empty-state-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #1f2937;
    }
    
    .empty-state-subtitle {
        font-size: 18px;
        line-height: 1.6;
        max-width: 480px;
    }
    
    .welcome-features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 40px;
        max-width: 600px;
    }
    
    .feature-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        text-align: center;
        transition: all 0.2s;
    }
    
    .feature-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }
    
    .feature-icon {
        font-size: 32px;
        margin-bottom: 12px;
    }
    
    .feature-title {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
    }
    
    .feature-desc {
        font-size: 14px;
        color: #6b7280;
        line-height: 1.4;
    }
    
    /* é”™è¯¯æ¶ˆæ¯ */
    .error-message {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border: 1px solid #f87171;
        color: #dc2626;
        padding: 16px 20px;
        border-radius: 12px;
        margin: 16px 0;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15);
    }
    
    /* æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’®æ ·å¼ */
    .scroll-to-bottom-btn {
        position: fixed;
        bottom: 140px;
        right: 30px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 100;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        pointer-events: none;
    }

    .scroll-to-bottom-btn.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
    }

    .scroll-to-bottom-btn:hover {
        background: #764ba2;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .chat-container {
            height: calc(100vh - 140px); /* ç§»åŠ¨ç«¯å‡å°‘é«˜åº¦ */
            margin: 10px;
            border-radius: 8px;
        }
        
        .chat-header {
            padding: 16px;
            flex-direction: column;
            gap: 12px;
        }
        
        .chat-controls {
            width: 100%;
            justify-content: center;
        }
        
        .conversations-sidebar {
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
        }
        
        .conversations-sidebar.open + .chat-area {
            margin-left: 0;
        }
        
        .message-content {
            max-width: 85%;
        }
        
        .messages-container {
            padding: 16px;
        }
        
        .input-area {
            padding: 16px;
            min-height: 80px; /* ç§»åŠ¨ç«¯å‡å°‘æœ€å°é«˜åº¦ */
        }
        
        .welcome-features {
            grid-template-columns: 1fr;
        }
    }
    
    /* æ»šåŠ¨æ¡æ ·å¼ */
    .messages-container::-webkit-scrollbar {
        width: 8px;
    }
    
    .messages-container::-webkit-scrollbar-track {
        background: #f8fafc;
        border-radius: 4px;
    }
    
    .messages-container::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
        transition: background 0.2s;
    }
    
    .messages-container::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    
    .conversations-list::-webkit-scrollbar {
        width: 6px;
    }
    
    .conversations-list::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }
    
    .conversations-list::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
        transition: background 0.2s;
    }
    
    .conversations-list::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    
    /* æ–°å¢ï¼šæ¶ˆæ¯å†…å®¹Markdownæ ·å¼ */
    .message-content {
        padding: 16px 20px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        max-width: 80%;
        word-wrap: break-word;
        line-height: 1.6;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        position: relative;
    }
    
    .message.user .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
        margin-left: auto;
    }
    
    .message.assistant .message-content {
        border-bottom-left-radius: 4px;
        margin-right: auto;
    }
    
    /* Markdownæ ·å¼ */
    .message-content h1,
    .message-content h2,
    .message-content h3,
    .message-content h4,
    .message-content h5,
    .message-content h6 {
        margin: 0.5em 0;
        font-weight: 600;
        color: #1f2937;
    }
    
    .message-content h1 { font-size: 1.5em; }
    .message-content h2 { font-size: 1.3em; }
    .message-content h3 { font-size: 1.1em; }
    
    .message-content strong {
        font-weight: 600;
        color: #1f2937;
    }
    
    .message-content em {
        font-style: italic;
        color: #374151;
    }
    
    .message-content ul,
    .message-content ol {
        margin: 0.5em 0;
        padding-left: 1.5em;
    }
    
    .message-content li {
        margin: 0.25em 0;
    }
    
    .message-content p {
        margin: 0.5em 0;
    }
    
    .message-content p:first-child {
        margin-top: 0;
    }
    
    .message-content p:last-child {
        margin-bottom: 0;
    }
    
    .message-content code {
        background: #f3f4f6;
        padding: 0.125em 0.25em;
        border-radius: 3px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875em;
    }
    
    .message-content pre {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 1em;
        overflow-x: auto;
        margin: 0.5em 0;
    }
    
    .message-content pre code {
        background: none;
        padding: 0;
    }
    
    .message-content blockquote {
        border-left: 4px solid #e5e7eb;
        margin: 0.5em 0;
        padding-left: 1em;
        color: #6b7280;
        font-style: italic;
    }
    
    .message-content a {
        color: #3b82f6;
        text-decoration: underline;
    }
    
    .message-content a:hover {
        color: #1d4ed8;
    }
    
    /* ç”¨æˆ·æ¶ˆæ¯ä¸­çš„æ–‡æœ¬ä¿æŒç™½è‰² */
    .message.user .message-content h1,
    .message.user .message-content h2,
    .message.user .message-content h3,
    .message.user .message-content h4,
    .message.user .message-content h5,
    .message.user .message-content h6,
    .message.user .message-content strong,
    .message.user .message-content p {
        color: white;
    }
    
    .message.user .message-content code {
        background: rgba(255,255,255,0.2);
        color: white;
    }
    
    .message.user .message-content pre {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .message.user .message-content blockquote {
        border-left-color: rgba(255,255,255,0.3);
        color: rgba(255,255,255,0.8);
    }
    
    /* æ¶ˆæ¯å®¹å™¨å¸ƒå±€ */
    .message {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 20px;
        animation: slideIn 0.3s ease;
    }
    
    .message.user {
        flex-direction: row-reverse;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .message.user .message-avatar {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .message-time {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 8px;
        opacity: 0.7;
        display: flex;
        justify-content: flex-end;
        padding-top: 4px;
    }
    
    .message.user .message-time {
        color: rgba(255,255,255,0.7);
    }
    
    /* æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’®æ ·å¼ */
    .scroll-to-bottom-btn {
        position: fixed;
        bottom: 140px;
        right: 30px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 100;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        pointer-events: none;
    }

    .scroll-to-bottom-btn.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
    }

    .scroll-to-bottom-btn:hover {
        background: #764ba2;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    }
    
    /* é®ç½©å±‚æ ·å¼ */
    .sidebar-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 5;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .sidebar-overlay.show {
        opacity: 1;
        pointer-events: auto;
    }
</style>
{% endblock %}

{% block content %}
<ol class="breadcrumb">
    <li class="breadcrumb-item">æ‚¨çš„ä½ç½®</li>
    <li class="breadcrumb-item active">
      <a href='{{url_for('dashboard.dashboard_application')}}'>åº”ç”¨ç¨‹åº</a>
    </li>
    <li class="breadcrumb-item active"> 
      <a href='{{url_for('dashboard.dashboard_kg')}}'>å¤§æ¨¡å‹ä¸çŸ¥è¯†å›¾è°±</a>
    </li>
    <li class="breadcrumb-item active">å¤§è¯­è¨€æ¨¡å‹</li>
</ol>

<div class="chat-container">
    <!-- é¡¶éƒ¨å¤´éƒ¨ -->
    <div class="chat-header">
        <div class="chat-title">
            <span>ğŸ­</span>
            <span>å·¥ä¸šæ™ºèƒ½AIåŠ©æ‰‹</span>
        </div>
        <div class="chat-controls">
            <button class="conversations-toggle" onclick="toggleConversations()">
                <span>ğŸ’¬</span>
                <span>å†å²å¯¹è¯</span>
            </button>
            <button class="new-chat-btn" id="newChatBtn" onclick="createNewConversation()">
                <span>â•</span>
                <span>æ–°å»ºå¯¹è¯</span>
            </button>
        </div>
    </div>
    
    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="chat-main">
        <!-- å¯¹è¯åˆ—è¡¨ä¾§è¾¹æ  -->
        <div class="conversations-sidebar" id="conversationsSidebar">
            <div class="conversations-header">
                <input type="text" class="conversations-search" placeholder="æœç´¢å¯¹è¯..." 
                       oninput="filterConversations(this.value)">
            </div>
            <div class="conversations-list" id="conversationsList">
                <!-- å¯¹è¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- é®ç½©å±‚ -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleConversations()"></div>
        
        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="chat-area">
            <div class="messages-container" id="messagesContainer">
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">ğŸ­</div>
                    <div class="empty-state-title">æ¬¢è¿ä½¿ç”¨å·¥ä¸šæ™ºèƒ½AIåŠ©æ‰‹</div>
                    <div class="empty-state-subtitle">
                        æˆ‘æ˜¯ä¸“æ³¨äºå·¥ä¸šé¢†åŸŸçš„æ™ºèƒ½AIåŠ©æ‰‹ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›åˆ¶é€ ä¸šã€è‡ªåŠ¨åŒ–ã€è®¾å¤‡ç»´æŠ¤ç­‰ä¸“ä¸šè§£ç­”
                    </div>
                    <div class="welcome-features">
                        <div class="feature-card">
                            <div class="feature-icon">âš™ï¸</div>
                            <div class="feature-title">è®¾å¤‡ç»´æŠ¤</div>
                            <div class="feature-desc">æä¾›è®¾å¤‡æ•…éšœè¯Šæ–­å’Œç»´æŠ¤å»ºè®®</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ¤–</div>
                            <div class="feature-title">è‡ªåŠ¨åŒ–æ–¹æ¡ˆ</div>
                            <div class="feature-desc">ååŠ©è®¾è®¡å’Œä¼˜åŒ–è‡ªåŠ¨åŒ–æµç¨‹</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ“Š</div>
                            <div class="feature-title">å·¥è‰ºä¼˜åŒ–</div>
                            <div class="feature-desc">åˆ†æç”Ÿäº§æ•°æ®ï¼Œä¼˜åŒ–å·¥è‰ºå‚æ•°</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="è¾“å…¥æ‚¨çš„å·¥ä¸šæŠ€æœ¯é—®é¢˜ï¼Œä¾‹å¦‚ï¼šå¦‚ä½•æé«˜ç”Ÿäº§çº¿æ•ˆç‡ï¼Ÿ"
                        rows="1"
                    ></textarea>
                    <!-- åœ¨HTMLä¸­ä¿®æ”¹å‘é€æŒ‰é’® -->
                    <button id="sendBtn" class="send-btn" onclick="sendMessageStream()">
                        <span>â†—</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentConversationId = null;
let conversations = [];
let isLoading = false;
let allConversations = [];
let currentStreamingMessage = null;
let useStreamMode = true;

// åˆå§‹åŒ–Markdownè§£æå™¨
let md;
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ é¡µé¢åˆå§‹åŒ–å¼€å§‹...');
    
    // åˆå§‹åŒ–markdown-it
    if (typeof markdownit !== 'undefined') {
        md = markdownit({
            html: false,        // ç¦ç”¨HTMLæ ‡ç­¾
            xhtmlOut: false,    // ä½¿ç”¨HTMLæ ¼å¼
            breaks: true,       // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
            linkify: true,      // è‡ªåŠ¨è¯†åˆ«é“¾æ¥
            typographer: true   // å¯ç”¨æ™ºèƒ½å¼•å·å’Œå…¶ä»–å°åˆ·ç¬¦å·
        });
        console.log('âœ… Markdownè§£æå™¨åˆå§‹åŒ–å®Œæˆ');
    } else {
        console.warn('âš ï¸ Markdownè§£æå™¨æœªåŠ è½½ï¼Œå°†ä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤º');
    }
    
    loadConversations();
    setupInputHandler();
    setupScrollEvents();
});

// æ¸²æŸ“Markdownå†…å®¹
function renderMarkdown(content) {
    if (!content) return '';
    
    // å¦‚æœmarkdownè§£æå™¨å¯ç”¨ï¼Œä½¿ç”¨å®ƒæ¸²æŸ“
    if (md) {
        try {
            return md.render(content);
        } catch (error) {
            console.warn('âš ï¸ Markdownæ¸²æŸ“å¤±è´¥ï¼Œä½¿ç”¨çº¯æ–‡æœ¬:', error);
            return escapeHtml(content);
        }
    }
    
    // å¦‚æœæ²¡æœ‰markdownè§£æå™¨ï¼Œæ‰‹åŠ¨å¤„ç†åŸºæœ¬æ ¼å¼
    return processBasicMarkdown(content);
}

// åŸºæœ¬Markdownå¤„ç†ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
function processBasicMarkdown(text) {
    if (!text) return '';
    
    // è½¬ä¹‰HTML
    text = escapeHtml(text);
    
    // å¤„ç†ç²—ä½“ **text**
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // å¤„ç†æ–œä½“ *text*
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // å¤„ç†ä»£ç  `code`
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // å¤„ç†æ¢è¡Œ
    text = text.replace(/\n/g, '<br>');
    
    // å¤„ç†æ ‡é¢˜ # ## ###
    text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
    text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
    text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');
    
    // å¤„ç†åˆ—è¡¨é¡¹ - item
    text = text.replace(/^- (.*$)/gm, '<li>$1</li>');
    text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
    
    return text;
}

// æ›´æ–°æµå¼æ¶ˆæ¯å†…å®¹ï¼ˆä½¿ç”¨Markdownæ¸²æŸ“ï¼‰
function updateStreamingMessage(messageElement, content) {
    if (!messageElement) return;
    
    const contentDiv = messageElement.querySelector('.streaming-content');
    if (contentDiv) {
        // ä½¿ç”¨Markdownæ¸²æŸ“ï¼Œè€Œä¸æ˜¯ç®€å•çš„HTMLè½¬ä¹‰
        contentDiv.innerHTML = renderMarkdown(content);
        
        // å¦‚æœç”¨æˆ·åœ¨åº•éƒ¨ï¼Œç»§ç»­æ»šåŠ¨
        if (isScrolledToBottom()) {
            scrollToBottom();
        }
    }
}

// åˆ›å»ºæµå¼æ¶ˆæ¯å…ƒç´ 
function createStreamingMessage() {
    const container = document.getElementById('messagesContainer');
    if (!container) {
        console.error('âŒ æ¶ˆæ¯å®¹å™¨æœªæ‰¾åˆ°');
        return null;
    }
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨åº•éƒ¨
    const shouldAutoScroll = isScrolledToBottom();
    
    const time = new Date().toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message assistant streaming';
    messageDiv.innerHTML = `
        <div class="message-avatar">ğŸ­</div>
        <div class="message-content">
            <div class="streaming-content"></div>
            <div class="message-time">${time}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    currentStreamingMessage = messageDiv;
    
    // åªæœ‰å½“ç”¨æˆ·åœ¨åº•éƒ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
    if (shouldAutoScroll) {
        scrollToBottom();
    }
    
    return messageDiv;
}

// ä¿®æ”¹æ·»åŠ æ¶ˆæ¯å‡½æ•°
function addMessage(role, content, created_at = null) {
    const container = document.getElementById('messagesContainer');
    if (!container) {
        console.error('âŒ æ¶ˆæ¯å®¹å™¨æœªæ‰¾åˆ°');
        return;
    }
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨åº•éƒ¨
    const shouldAutoScroll = isScrolledToBottom();
    
    // ç¡®ä¿ç§»é™¤ç©ºçŠ¶æ€
    const emptyState = container.querySelector('#emptyState');
    if (emptyState) {
        emptyState.remove();
    }
    
    // å¦‚æœæ²¡æœ‰æä¾›åˆ›å»ºæ—¶é—´ï¼Œåˆ™ä½¿ç”¨å½“å‰æ—¶é—´
    const messageTime = created_at ? formatMessageTime(created_at) : formatMessageTime(new Date());
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    messageDiv.innerHTML = `
        <div class="message-avatar">
            ${role === 'user' ? 'ğŸ‘¤' : 'ğŸ­'}
        </div>
        <div class="message-content">
            ${renderMarkdown(content)}
            <div class="message-time">${messageTime}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    
    // åªæœ‰å½“ç”¨æˆ·åœ¨åº•éƒ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
    if (shouldAutoScroll) {
        scrollToBottom();
    }
}

// æ ¼å¼åŒ–æ¶ˆæ¯æ—¶é—´ - ä½¿ç”¨ä¸œå…«åŒºæ—¶é—´å¹¶æ˜¾ç¤ºæ—¥æœŸ
function formatMessageTime(dateString) {
    if (!dateString) {
        return '';
    }
    
    let date;
    // å¤„ç†SQLiteçš„ISOæ ¼å¼æˆ–æ—¶é—´æˆ³
    try {
        date = new Date(dateString);
        
        // å¦‚æœæ— æ•ˆï¼Œå°è¯•å…¶ä»–æ ¼å¼
        if (isNaN(date.getTime())) {
            // SQLiteæ ¼å¼å¯èƒ½æ˜¯ YYYY-MM-DD HH:MM:SS
            if (typeof dateString === 'string' && dateString.includes('-')) {
                // å°è¯•æ·»åŠ  'T' å’Œ 'Z' ä½¿ä¹‹æˆä¸ºæœ‰æ•ˆçš„ISOæ ¼å¼
                date = new Date(dateString.replace(' ', 'T') + '.000+08:00');
            }
        }
    } catch (e) {
        console.warn('æ— æ³•è§£ææ—¥æœŸ:', dateString);
        // å¦‚æœæ— æ³•è§£æï¼Œåˆ™ä½¿ç”¨å½“å‰æ—¶é—´
        date = new Date();
    }
    
    // å¦‚æœä»ç„¶æ— æ•ˆï¼Œè¿”å›ä¸€ä¸ªå ä½ç¬¦
    if (isNaN(date.getTime())) {
        return '--/-- --:--';
    }
    
    // ç¡®ä¿ä½¿ç”¨ä¸œå…«åŒºæ—¶é—´
    const options = { 
        timeZone: 'Asia/Shanghai',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    };
    
    // ä»Šå¤©çš„æ—¥æœŸï¼ˆä¸œå…«åŒºï¼‰
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    // æ—¥æœŸæ¯”è¾ƒ
    const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const diffDays = Math.floor((today - messageDate) / (1000 * 60 * 60 * 24));
    
    // æ ¹æ®æ—¥æœŸè·ç¦»æ˜¾ç¤ºä¸åŒæ ¼å¼
    if (diffDays === 0) {
        // ä»Šå¤©: åªæ˜¾ç¤ºæ—¶é—´
        return 'ä»Šå¤© ' + new Intl.DateTimeFormat('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: 'Asia/Shanghai'
        }).format(date);
    } else if (diffDays === 1) {
        // æ˜¨å¤©: æ˜¾ç¤º"æ˜¨å¤©"å’Œæ—¶é—´
        return 'æ˜¨å¤© ' + new Intl.DateTimeFormat('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: 'Asia/Shanghai'
        }).format(date);
    } else if (diffDays < 7) {
        // ä¸€å‘¨å†…: æ˜¾ç¤ºæ˜ŸæœŸå‡ å’Œæ—¶é—´
        const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        const weekday = weekdays[date.getDay()];
        return weekday + ' ' + new Intl.DateTimeFormat('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: 'Asia/Shanghai'
        }).format(date);
    } else if (date.getFullYear() === now.getFullYear()) {
        // åŒä¸€å¹´: æ˜¾ç¤ºæœˆ-æ—¥ æ—¶:åˆ†
        return new Intl.DateTimeFormat('zh-CN', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: 'Asia/Shanghai'
        }).format(date);
    } else {
        // ä¸åŒå¹´: æ˜¾ç¤ºå®Œæ•´æ—¥æœŸæ—¶é—´
        return new Intl.DateTimeFormat('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: 'Asia/Shanghai'
        }).format(date);
    }
}

// ä¿®æ”¹æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨å‡½æ•°
function renderMessages(messages) {
    const container = document.getElementById('messagesContainer');
    if (!container) {
        console.error('âŒ æ¶ˆæ¯å®¹å™¨æœªæ‰¾åˆ°');
        return;
    }
    
    if (!messages || messages.length === 0) {
        initializeEmptyChat();
        return;
    }
    
    // è®°å½•å½“å‰æ»šåŠ¨ä½ç½®
    const scrollTop = container.scrollTop;
    const isAtBottom = isScrolledToBottom();
    
    // æ¸…ç©ºå®¹å™¨å¹¶æ¸²æŸ“æ¶ˆæ¯
    container.innerHTML = messages.map(msg => {
        // ä½¿ç”¨æ¶ˆæ¯çš„å®é™…åˆ›å»ºæ—¶é—´
        const time = formatMessageTime(msg.created_at);
        
        return `
            <div class="message ${msg.role}">
                <div class="message-avatar">
                    ${msg.role === 'user' ? 'ğŸ‘¤' : 'ğŸ­'}
                </div>
                <div class="message-content">
                    ${renderMarkdown(msg.content || '')}
                    <div class="message-time">${time}</div>
                </div>
            </div>
        `;
    }).join('');
    
    // æ¢å¤æ»šåŠ¨ä½ç½®æˆ–æ»šåŠ¨åˆ°åº•éƒ¨
    requestAnimationFrame(() => {
        if (isAtBottom || messages.length <= 2) {
            // å¦‚æœä¹‹å‰åœ¨åº•éƒ¨æˆ–æ¶ˆæ¯å¾ˆå°‘ï¼Œæ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
        } else {
            // å¦åˆ™æ¢å¤ä¹‹å‰çš„ä½ç½®
            container.scrollTop = scrollTop;
        }
    });
    
    console.log(`âœ… æ¸²æŸ“äº† ${messages.length} æ¡æ¶ˆæ¯`);
}

// æ¸²æŸ“å¯¹è¯åˆ—è¡¨
function renderConversations() {
    const container = document.getElementById('conversationsList');
    
    if (!container) {
        console.error('âŒ å¯¹è¯åˆ—è¡¨å®¹å™¨æœªæ‰¾åˆ°');
        return;
    }
    
    if (conversations.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;">æš‚æ— å¯¹è¯</div>';
        return;
    }
    
    container.innerHTML = conversations.map(conv => {
        // ä½¿ç”¨ä¸æ¶ˆæ¯ç›¸åŒçš„æ ¼å¼åŒ–å‡½æ•°ï¼Œç¡®ä¿ä¸€è‡´æ€§
        const date = formatMessageTime(conv.created_at);
        
        return `
            <div class="conversation-item ${conv.chat_id === currentConversationId ? 'active' : ''}" 
                 onclick="selectConversation('${conv.chat_id}')">
                <div class="conversation-content">
                    <div class="conversation-title">${escapeHtml(conv.title || 'æ–°å¯¹è¯')}</div>
                    <div class="conversation-preview">${escapeHtml(conv.last_message || 'æš‚æ— æ¶ˆæ¯')}</div>
                    <div class="conversation-date">${date}</div>
                </div>
                <div class="conversation-actions">
                    <button class="delete-btn" onclick="deleteConversation('${conv.chat_id}', event)" title="åˆ é™¤å¯¹è¯">Ã—</button>
                </div>
            </div>
        `;
    }).join('');
    
    console.log(`âœ… æ¸²æŸ“äº† ${conversations.length} ä¸ªå¯¹è¯`);
}

// HTMLè½¬ä¹‰å‡½æ•°
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// åˆ›å»ºæ–°å¯¹è¯
async function createNewConversation() {
    if (isLoading) return;
    
    try {
        console.log('ğŸ†• å¼€å§‹åˆ›å»ºæ–°å¯¹è¯...');
        isLoading = true;
        updateButtonStates();
        
        const response = await fetch('/llm/conversations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('ğŸ“Š åˆ›å»ºå¯¹è¯å“åº”:', data);
        
        if (data.success) {
            currentConversationId = data.chat_id;
            console.log(`âœ… æ–°å¯¹è¯åˆ›å»ºæˆåŠŸ: ${currentConversationId}`);
            
            await loadConversations();
            initializeEmptyChat();
            
            // å…³é—­ä¾§è¾¹æ å¹¶èšç„¦è¾“å…¥æ¡†
            const sidebar = document.getElementById('conversationsSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            
            const input = document.getElementById('messageInput');
            if (input) input.focus();
        } else {
            throw new Error(data.message || 'åˆ›å»ºå¯¹è¯å¤±è´¥');
        }
    } catch (error) {
        console.error('âŒ åˆ›å»ºå¯¹è¯å¤±è´¥:', error);
        showError('åˆ›å»ºå¯¹è¯å¤±è´¥ï¼š' + error.message);
    } finally {
        isLoading = false;
        updateButtonStates();
    }
}

// åŠ è½½å¯¹è¯åˆ—è¡¨
async function loadConversations() {
    try {
        console.log('ğŸ“‹ å¼€å§‹åŠ è½½å¯¹è¯åˆ—è¡¨...');
        
        const response = await fetch('/llm/conversations');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('ğŸ“Š å¯¹è¯åˆ—è¡¨æ•°æ®:', data);
        
        if (data.success) {
            conversations = data.conversations || [];
            allConversations = [...conversations];
            
            renderConversations();
            
            // å¦‚æœæœ‰å¯¹è¯ä½†æ²¡æœ‰é€‰æ‹©å½“å‰å¯¹è¯ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
            if (conversations.length > 0 && !currentConversationId) {
                console.log('ğŸ¯ é€‰æ‹©ç¬¬ä¸€ä¸ªå¯¹è¯...');
                selectConversation(conversations[0].chat_id);
            }
        } else {
            throw new Error(data.message || 'è·å–å¯¹è¯åˆ—è¡¨å¤±è´¥');
        }
    } catch (error) {
        console.error('âŒ åŠ è½½å¯¹è¯å¤±è´¥:', error);
        showError('åŠ è½½å¯¹è¯å¤±è´¥ï¼š' + error.message);
    }
}

// å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
function smoothScrollToBottom() {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    container.scrollTo({
        top: container.scrollHeight,
        behavior: 'smooth'
    });
}

// ç«‹å³æ»šåŠ¨åˆ°åº•éƒ¨
function scrollToBottom() {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    container.scrollTop = container.scrollHeight;
}

// æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨
function isScrolledToBottom() {
    const container = document.getElementById('messagesContainer');
    if (!container) return true;
    
    // å®¹å·®å€¼ï¼Œè€ƒè™‘åˆ°æŸäº›æµè§ˆå™¨çš„èˆå…¥è¯¯å·®
    const tolerance = 50;
    
    return container.scrollHeight - container.clientHeight - container.scrollTop <= tolerance;
}

// åˆ‡æ¢å¯¹è¯åˆ—è¡¨ä¾§è¾¹æ æ˜¾ç¤º/éšè—
function toggleConversations() {
    const sidebar = document.getElementById('conversationsSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    if (!sidebar || !overlay) {
        console.error('âŒ ä¾§è¾¹æ å…ƒç´ æœªæ‰¾åˆ°');
        return;
    }
    
    // åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤ºçŠ¶æ€
    sidebar.classList.toggle('open');
    
    // åˆ‡æ¢é®ç½©å±‚æ˜¾ç¤ºçŠ¶æ€
    if (sidebar.classList.contains('open')) {
        overlay.classList.add('show');
    } else {
        overlay.classList.remove('show');
    }
}

// è®¾ç½®æ»šåŠ¨äº‹ä»¶
function setupScrollEvents() {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    // æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬
    container.addEventListener('scroll', function() {
        // æ›´æ–°æ»šåŠ¨æŒ‰é’®çŠ¶æ€
        const scrollButton = document.getElementById('scrollToBottomBtn');
        if (scrollButton) {
            if (isScrolledToBottom()) {
                scrollButton.classList.remove('show');
            } else {
                scrollButton.classList.add('show');
            }
        }
    });
    
    // æ·»åŠ æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’®
    addScrollToBottomButton();
    
    console.log('âœ… æ»šåŠ¨äº‹ä»¶è®¾ç½®å®Œæˆ');
}

// è¿‡æ»¤å¯¹è¯åˆ—è¡¨
function filterConversations(searchTerm) {
    if (!searchTerm) {
        conversations = [...allConversations];
    } else {
        searchTerm = searchTerm.toLowerCase();
        conversations = allConversations.filter(conv => 
            (conv.title && conv.title.toLowerCase().includes(searchTerm)) || 
            (conv.last_message && conv.last_message.toLowerCase().includes(searchTerm))
        );
    }
    
    renderConversations();
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    
    container.appendChild(errorDiv);
    
    // 5ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        if (errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
        }
    }, 5000);
}

// æ›´æ–°æŒ‰é’®çŠ¶æ€
function updateButtonStates() {
    const sendBtn = document.getElementById('sendBtn');
    const input = document.getElementById('messageInput');
    const newChatBtn = document.getElementById('newChatBtn');
    
    if (sendBtn && input) {
        sendBtn.disabled = isLoading || !input.value.trim();
    }
    
    if (newChatBtn) {
        newChatBtn.disabled = isLoading;
    }
}

// å¤„ç†æµå¼æ•°æ®
function handleStreamData(data, messageElement) {
    console.log('ğŸ“Š æµå¼æ•°æ®:', data.type);
    
    switch (data.type) {
        case 'start':
            console.log('ğŸš€ å¼€å§‹æ¥æ”¶æµå¼å“åº”');
            // å¯ä»¥æ˜¾ç¤º"æ­£åœ¨æ€è€ƒ..."çš„çŠ¶æ€
            break;
            
        case 'content':
            // æ›´æ–°æ¶ˆæ¯å†…å®¹ - ä½¿ç”¨renderMarkdownè€Œä¸æ˜¯escapeHtml
            updateStreamingMessage(messageElement, data.content);
            break;
            
        case 'done':
            console.log('âœ… æµå¼å“åº”å®Œæˆ');
            // ç§»é™¤æµå¼æ ·å¼
            if (messageElement) {
                messageElement.classList.remove('streaming');
            }
            break;
            
        case 'error':
            console.error('âŒ æµå¼å“åº”é”™è¯¯:', data.content);
            updateStreamingMessage(messageElement, data.content);
            if (messageElement) {
                messageElement.classList.remove('streaming');
                messageElement.classList.add('error');
            }
            break;
    }
}

// æµå¼å‘é€æ¶ˆæ¯
async function sendMessageStream() {
    const input = document.getElementById('messageInput');
    const message = input ? input.value.trim() : '';
    
    if (!message || isLoading) return;
    
    try {
        console.log(`ğŸ’¬ å‘é€æµå¼æ¶ˆæ¯: ${message.substring(0, 50)}...`);
        
        // å¦‚æœæ²¡æœ‰å½“å‰å¯¹è¯ï¼Œåˆ›å»ºä¸€ä¸ª
        if (!currentConversationId) {
            console.log('ğŸ†• æ²¡æœ‰å½“å‰å¯¹è¯ï¼Œåˆ›å»ºæ–°å¯¹è¯...');
            await createNewConversation();
            if (!currentConversationId) {
                throw new Error('æ— æ³•åˆ›å»ºå¯¹è¯');
            }
        }
        
        isLoading = true;
        updateButtonStates();
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        input.value = '';
        input.style.height = 'auto';
        
        // ç¡®ä¿æ¶ˆæ¯å®¹å™¨å‡†å¤‡å¥½
        ensureMessageContainer();
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addMessage('user', message);
        
        // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨ï¼ˆç©ºå†…å®¹ï¼Œç”¨äºæµå¼å¡«å……ï¼‰
        const aiMessageElement = createStreamingMessage();
        
        try {
            const response = await fetch('/llm/chat/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    chat_id: currentConversationId
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
                const { done, value } = await reader.read();
                
                if (done) {
                    console.log('âœ… æµå¼å“åº”å®Œæˆ');
                    break;
                }
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const jsonStr = line.slice(6);
                            // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºæˆ–æ— æ•ˆæ•°æ®
                            if (!jsonStr.trim()) continue;
                            
                            const data = JSON.parse(jsonStr);
                            handleStreamData(data, aiMessageElement);
                        } catch (e) {
                            console.warn('âš ï¸ è§£ææµæ•°æ®å¤±è´¥:', e);
                            console.warn('åŸå§‹æ•°æ®:', line);
                            
                            // å°è¯•ä¿®å¤å¸¸è§çš„JSONé—®é¢˜
                            try {
                                const jsonStr = line.slice(6);
                                // ç§»é™¤å¯èƒ½çš„æ§åˆ¶å­—ç¬¦
                                const cleanedStr = jsonStr.replace(/[\x00-\x1F\x7F]/g, '');
                                const data = JSON.parse(cleanedStr);
                                handleStreamData(data, aiMessageElement);
                            } catch (retryError) {
                                console.warn('âš ï¸ é‡è¯•è§£æä¹Ÿå¤±è´¥ï¼Œè·³è¿‡æ­¤æ•°æ®å—');
                                // å¦‚æœä»ç„¶å¤±è´¥ï¼Œå°è¯•æå–å†…å®¹
                                if (line.includes('"content"')) {
                                    const contentMatch = line.match(/"content":\s*"([^"]*?)"/);
                                    if (contentMatch) {
                                        handleStreamData({
                                            type: 'content',
                                            content: contentMatch[1]
                                        }, aiMessageElement);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // æ›´æ–°å¯¹è¯åˆ—è¡¨
            await loadConversations();
            
        } catch (fetchError) {
            console.error('âŒ æµå¼è¯·æ±‚å¤±è´¥:', fetchError);
            updateStreamingMessage(aiMessageElement, 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•ï¼š' + fetchError.message);
            if (aiMessageElement) {
                aiMessageElement.classList.remove('streaming');
                aiMessageElement.classList.add('error');
            }
        }
        
    } catch (error) {
        console.error('âŒ å‘é€æµå¼æ¶ˆæ¯å¤±è´¥:', error);
        if (currentStreamingMessage) {
            updateStreamingMessage(currentStreamingMessage, 'å‘é€æ¶ˆæ¯å¤±è´¥ï¼š' + error.message);
            currentStreamingMessage.classList.remove('streaming');
            currentStreamingMessage.classList.add('error');
        }
    } finally {
        currentStreamingMessage = null;
        isLoading = false;
        updateButtonStates();
        
        // é‡æ–°èšç„¦è¾“å…¥æ¡†
        if (input) input.focus();
    }
}

// è®¾ç½®è¾“å…¥æ¡†äº‹ä»¶å¤„ç†
function setupInputHandler() {
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    
    if (!input || !sendBtn) {
        console.error('âŒ è¾“å…¥æ¡†æˆ–å‘é€æŒ‰é’®æœªæ‰¾åˆ°');
        return;
    }
    
    // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        
        // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
        updateButtonStates();
    });
    
    // å›è½¦å‘é€
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!isLoading && this.value.trim()) {
                if (useStreamMode) {
                    sendMessageStream();
                } else {
                    sendMessage();
                }
            }
        }
    });
    
    // åˆå§‹çŠ¶æ€
    updateButtonStates();
    console.log('âœ… è¾“å…¥æ¡†äº‹ä»¶è®¾ç½®å®Œæˆ');
}

// æ™®é€šå‘é€æ¶ˆæ¯ï¼ˆéæµå¼ï¼Œå¤‡ç”¨ï¼‰
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input ? input.value.trim() : '';
    
    if (!message || isLoading) return;
    
    try {
        // å¦‚æœæ²¡æœ‰å½“å‰å¯¹è¯ï¼Œåˆ›å»ºä¸€ä¸ª
        if (!currentConversationId) {
            await createNewConversation();
            if (!currentConversationId) {
                throw new Error('æ— æ³•åˆ›å»ºå¯¹è¯');
            }
        }
        
        isLoading = true;
        updateButtonStates();
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        input.value = '';
        input.style.height = 'auto';
        
        // ç¡®ä¿æ¶ˆæ¯å®¹å™¨å‡†å¤‡å¥½
        ensureMessageContainer();
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addMessage('user', message);
        
        // æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨
        showTypingIndicator();
        
        const response = await fetch('/llm/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                chat_id: currentConversationId
            })
        });
        
        // éšè—è¾“å…¥æŒ‡ç¤ºå™¨
        hideTypingIndicator();
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            addMessage('assistant', data.response);
            
            // æ›´æ–°å¯¹è¯åˆ—è¡¨
            await loadConversations();
        } else {
            throw new Error(data.message || 'æ¶ˆæ¯å‘é€å¤±è´¥');
        }
        
    } catch (error) {
        console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥:', error);
        hideTypingIndicator();
        showError('å‘é€æ¶ˆæ¯å¤±è´¥ï¼š' + error.message);
    } finally {
        isLoading = false;
        updateButtonStates();
        
        // é‡æ–°èšç„¦è¾“å…¥æ¡†
        if (input) input.focus();
    }
}

// é€‰æ‹©å¯¹è¯
async function selectConversation(chat_id) {
    if (isLoading || currentConversationId === chat_id) return;
    
    try {
        console.log(`ğŸ¯ é€‰æ‹©å¯¹è¯: ${chat_id}`);
        isLoading = true;
        updateButtonStates();
        
        // æ›´æ–°UIä¸­çš„æ´»è·ƒå¯¹è¯
        currentConversationId = chat_id;
        renderConversations();
        
        // è·å–å¯¹è¯æ¶ˆæ¯
        const response = await fetch(`/llm/conversations/${chat_id}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('ğŸ“Š å¯¹è¯è¯¦æƒ…:', data);
        
        if (data.success) {
            // æ¸²æŸ“æ¶ˆæ¯
            renderMessages(data.messages);
        } else {
            throw new Error(data.message || 'è·å–å¯¹è¯æ¶ˆæ¯å¤±è´¥');
        }
    } catch (error) {
        console.error('âŒ é€‰æ‹©å¯¹è¯å¤±è´¥:', error);
        showError('è·å–å¯¹è¯å¤±è´¥ï¼š' + error.message);
    } finally {
        isLoading = false;
        updateButtonStates();
    }
}

// åˆ é™¤å¯¹è¯
async function deleteConversation(chat_id, event) {
    // é˜»æ­¢å†’æ³¡ï¼Œé¿å…è§¦å‘å¯¹è¯é€‰æ‹©
    if (event) {
        event.stopPropagation();
    }
    
    if (isLoading || !chat_id) return;
    
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
    }
    
    try {
        console.log(`ğŸ—‘ï¸ åˆ é™¤å¯¹è¯: ${chat_id}`);
        isLoading = true;
        
        const response = await fetch(`/llm/conversations/${chat_id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('ğŸ“Š åˆ é™¤å“åº”:', data);
        
        if (data.success) {
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œæ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
            if (chat_id === currentConversationId) {
                currentConversationId = null;
                initializeEmptyChat();
            }
            
            // é‡æ–°åŠ è½½å¯¹è¯åˆ—è¡¨
            await loadConversations();
        } else {
            throw new Error(data.message || 'åˆ é™¤å¯¹è¯å¤±è´¥');
        }
    } catch (error) {
        console.error('âŒ åˆ é™¤å¯¹è¯å¤±è´¥:', error);
        showError('åˆ é™¤å¯¹è¯å¤±è´¥ï¼š' + error.message);
    } finally {
        isLoading = false;
        updateButtonStates();
    }
}

// åˆå§‹åŒ–ç©ºèŠå¤©ç•Œé¢
function initializeEmptyChat() {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    container.innerHTML = `
        <div class="empty-state" id="emptyState">
            <div class="empty-state-icon">ğŸ­</div>
            <div class="empty-state-title">æ¬¢è¿ä½¿ç”¨å·¥ä¸šæ™ºèƒ½AIåŠ©æ‰‹</div>
            <div class="empty-state-subtitle">
                æˆ‘æ˜¯ä¸“æ³¨äºå·¥ä¸šé¢†åŸŸçš„æ™ºèƒ½AIåŠ©æ‰‹ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›åˆ¶é€ ä¸šã€è‡ªåŠ¨åŒ–ã€è®¾å¤‡ç»´æŠ¤ç­‰ä¸“ä¸šè§£ç­”
            </div>
            <div class="welcome-features">
                <div class="feature-card">
                    <div class="feature-icon">âš™ï¸</div>
                    <div class="feature-title">è®¾å¤‡ç»´æŠ¤</div>
                    <div class="feature-desc">æä¾›è®¾å¤‡æ•…éšœè¯Šæ–­å’Œç»´æŠ¤å»ºè®®</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">ğŸ¤–</div>
                    <div class="feature-title">è‡ªåŠ¨åŒ–æ–¹æ¡ˆ</div>
                    <div class="feature-desc">ååŠ©è®¾è®¡å’Œä¼˜åŒ–è‡ªåŠ¨åŒ–æµç¨‹</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">ğŸ“Š</div>
                    <div class="feature-title">å·¥è‰ºä¼˜åŒ–</div>
                    <div class="feature-desc">åˆ†æç”Ÿäº§æ•°æ®ï¼Œä¼˜åŒ–å·¥è‰ºå‚æ•°</div>
                </div>
            </div>
        </div>
    `;
    
    console.log('âœ… åˆå§‹åŒ–ç©ºèŠå¤©ç•Œé¢å®Œæˆ');
}

// ç¡®ä¿æ¶ˆæ¯å®¹å™¨å‡†å¤‡å¥½
function ensureMessageContainer() {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    // ç§»é™¤æ¬¢è¿å±å¹•
    const emptyState = container.querySelector('#emptyState');
    if (emptyState) {
        emptyState.remove();
    }
}

// æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨
function showTypingIndicator() {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.id = 'typingIndicator';
    typingDiv.innerHTML = `
        <div class="message-avatar">ğŸ­</div>
        <div class="typing-content">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    `;
    
    container.appendChild(typingDiv);
    
    // å¦‚æœç”¨æˆ·åœ¨åº•éƒ¨ï¼Œè‡ªåŠ¨æ»šåŠ¨
    if (isScrolledToBottom()) {
        scrollToBottom();
    }
}

// éšè—è¾“å…¥æŒ‡ç¤ºå™¨
function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator && typingIndicator.parentNode) {
        typingIndicator.parentNode.removeChild(typingIndicator);
    }
}

// æ·»åŠ "æ»šåŠ¨åˆ°åº•éƒ¨"æŒ‰é’®
function addScrollToBottomButton() {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨æŒ‰é’®
    let scrollButton = document.getElementById('scrollToBottomBtn');
    if (!scrollButton) {
        scrollButton = document.createElement('button');
        scrollButton.id = 'scrollToBottomBtn';
        scrollButton.className = 'scroll-to-bottom-btn';
        scrollButton.innerHTML = 'â†“';
        scrollButton.title = 'æ»šåŠ¨åˆ°åº•éƒ¨';
        scrollButton.onclick = smoothScrollToBottom;
        
        // æ·»åŠ åˆ°æ–‡æ¡£
        document.body.appendChild(scrollButton);
    }
    
    // æ ¹æ®æ»šåŠ¨ä½ç½®æ˜¾ç¤º/éšè—æŒ‰é’®
    container.addEventListener('scroll', function() {
        if (isScrolledToBottom()) {
            scrollButton.classList.remove('show');
        } else {
            scrollButton.classList.add('show');
        }
    });
    
    console.log('âœ… æ·»åŠ æ»šåŠ¨æŒ‰é’®å®Œæˆ');
}
</script>
{% endblock %}