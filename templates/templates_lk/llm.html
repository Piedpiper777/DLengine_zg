{% extends "templates_lk/base.html" %}

{% block styles %}
{{ super() }} 

<!-- 使用更稳定的CDN，并添加备用方案 -->
<script src="https://unpkg.com/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
<script>
// 备用CDN加载
if (typeof markdownit === 'undefined') {
    console.warn('⚠️ 主CDN加载失败，尝试备用CDN...');
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js';
    script.onload = function() {
        console.log('✅ 备用CDN加载成功');
        // 重新初始化markdown解析器
        if (typeof markdownit !== 'undefined') {
            md = markdownit({
                html: false,
                xhtmlOut: false,
                breaks: true,
                linkify: true,
                typographer: true
            });
            console.log('✅ Markdown解析器重新初始化完成');
        }
    };
    script.onerror = function() {
        console.warn('⚠️ 备用CDN也加载失败，将使用基础Markdown处理');
    };
    document.head.appendChild(script);
}
</script>

<style>
    .chat-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.1);
        overflow: hidden;
        height: calc(100vh - 180px);
        display: flex;
        flex-direction: column;
    }
    
    /* 顶部头部区域 */
    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0; /* 防止头部被压缩 */
    }
    
    .chat-title {
        font-size: 24px;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .chat-controls {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .conversations-toggle {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .conversations-toggle:hover {
        background: rgba(255,255,255,0.3);
    }
    
    .new-chat-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .new-chat-btn:hover:not(:disabled) {
        background: rgba(255,255,255,0.3);
    }
    
    .new-chat-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* 主要内容区域 */
    .chat-main {
        flex: 1;
        display: flex;
        position: relative;
        min-height: 0; /* 确保flex子元素可以缩小 */
    }
    
    /* 对话列表侧边栏 */
    .conversations-sidebar {
        width: 320px;
        background: #f8fafc;
        border-right: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        z-index: 10;
        transform: translateX(-100%);
    }
    
    .conversations-sidebar.open {
        transform: translateX(0);
    }
    
    .conversations-header {
        padding: 16px;
        border-bottom: 1px solid #e2e8f0;
        background: white;
        flex-shrink: 0; /* 防止头部被压缩 */
    }
    
    .conversations-search {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        outline: none;
        box-sizing: border-box;
    }
    
    .conversations-search:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .conversations-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
        min-height: 0; /* 允许滚动 */
    }
    
    .conversation-item {
        padding: 12px;
        margin: 4px 0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        background: white;
        position: relative;
    }
    
    .conversation-item:hover {
        background: #f1f5f9;
        border-color: #e2e8f0;
    }
    
    .conversation-item.active {
        background: #eff6ff;
        border-color: #3b82f6;
    }
    
    .conversation-content {
        width: 100%;
    }
    
    .conversation-title {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 4px;
        color: #1f2937;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .conversation-preview {
        font-size: 12px;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .conversation-date {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 4px;
    }
    
    .conversation-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .conversation-item:hover .conversation-actions {
        opacity: 1;
    }
    
    .delete-btn {
        background: #ef4444;
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .delete-btn:hover {
        background: #dc2626;
        transform: scale(1.1);
    }
    
    /* 聊天区域 */
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fafafa;
        transition: all 0.3s ease;
        min-height: 0; /* 确保flex子元素可以缩小 */
    }
    
    .conversations-sidebar.open + .chat-area {
        margin-left: 320px;
    }
    
    .messages-container {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 24px;
        background: #fafafa;
        scroll-behavior: smooth;
        min-height: 0; /* 关键：允许容器缩小 */
    }
    
    /* 输入区域 - 固定高度，防止被压缩 */
    .input-area {
        padding: 20px 24px;
        background: white;
        border-top: 1px solid #e5e7eb;
        flex-shrink: 0; /* 防止输入区域被压缩 */
        min-height: 100px; /* 确保输入区域有足够的最小高度 */
    }
    
    .input-container {
        max-width: 800px;
        margin: 0 auto;
        position: relative;
        background: #f8fafc;
        border-radius: 16px;
        border: 2px solid #e2e8f0;
        transition: all 0.2s;
        min-height: 60px; /* 确保容器有最小高度 */
    }
    
    .input-container:focus-within {
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }
    
    .message-input {
        width: 100%;
        min-height: 50px;
        max-height: 200px;
        padding: 15px 60px 15px 20px;
        border: none;
        background: transparent;
        font-size: 16px;
        line-height: 1.5;
        resize: none;
        outline: none;
        font-family: inherit;
        box-sizing: border-box; /* 确保padding被正确计算 */
    }
    
    .message-input::placeholder {
        color: #9ca3af;
    }
    
    .send-btn {
        position: absolute;
        right: 8px;
        bottom: 8px;
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        flex-shrink: 0; /* 防止按钮被压缩 */
    }
    
    .send-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .send-btn:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    /* 输入指示器 */
    .typing-indicator {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 20px;
        animation: slideIn 0.3s ease;
    }
    
    .typing-indicator .message-avatar {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .typing-content {
        padding: 16px 20px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    
    .typing-dots {
        display: flex;
        gap: 4px;
    }
    
    .typing-dot {
        width: 8px;
        height: 8px;
        background: #9ca3af;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    /* 空状态 */
    .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        color: #6b7280;
        padding: 60px 40px;
        min-height: 400px;
    }
    
    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .empty-state-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #1f2937;
    }
    
    .empty-state-subtitle {
        font-size: 18px;
        line-height: 1.6;
        max-width: 480px;
    }
    
    .welcome-features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 40px;
        max-width: 600px;
    }
    
    .feature-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        text-align: center;
        transition: all 0.2s;
    }
    
    .feature-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }
    
    .feature-icon {
        font-size: 32px;
        margin-bottom: 12px;
    }
    
    .feature-title {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
    }
    
    .feature-desc {
        font-size: 14px;
        color: #6b7280;
        line-height: 1.4;
    }
    
    /* 错误消息 */
    .error-message {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border: 1px solid #f87171;
        color: #dc2626;
        padding: 16px 20px;
        border-radius: 12px;
        margin: 16px 0;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15);
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
        .chat-container {
            height: calc(100vh - 140px); /* 移动端减少高度 */
            margin: 10px;
            border-radius: 8px;
        }
        
        .chat-header {
            padding: 16px;
            flex-direction: column;
            gap: 12px;
        }
        
        .chat-controls {
            width: 100%;
            justify-content: center;
        }
        
        .conversations-sidebar {
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
        }
        
        .conversations-sidebar.open + .chat-area {
            margin-left: 0;
        }
        
        .message-content {
            max-width: 85%;
        }
        
        .messages-container {
            padding: 16px;
        }
        
        .input-area {
            padding: 16px;
            min-height: 80px; /* 移动端减少最小高度 */
        }
        
        .welcome-features {
            grid-template-columns: 1fr;
        }
    }
    
    /* 滚动条样式 */
    .messages-container::-webkit-scrollbar {
        width: 8px;
    }
    
    .messages-container::-webkit-scrollbar-track {
        background: #f8fafc;
        border-radius: 4px;
    }
    
    .messages-container::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
        transition: background 0.2s;
    }
    
    .messages-container::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    
    .conversations-list::-webkit-scrollbar {
        width: 6px;
    }
    
    .conversations-list::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }
    
    .conversations-list::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
        transition: background 0.2s;
    }
    
    .conversations-list::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    
    /* 新增：消息内容Markdown样式 */
    .message-content {
        padding: 16px 20px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        max-width: 80%;
        word-wrap: break-word;
        line-height: 1.6;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        position: relative;
    }
    
    .message.user .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
        margin-left: auto;
    }
    
    .message.assistant .message-content {
        border-bottom-left-radius: 4px;
        margin-right: auto;
    }
    
    /* Markdown样式 */
    .message-content h1,
    .message-content h2,
    .message-content h3,
    .message-content h4,
    .message-content h5,
    .message-content h6 {
        margin: 0.5em 0;
        font-weight: 600;
        color: #1f2937;
    }
    
    .message-content h1 { font-size: 1.5em; }
    .message-content h2 { font-size: 1.3em; }
    .message-content h3 { font-size: 1.1em; }
    
    .message-content strong {
        font-weight: 600;
        color: #1f2937;
    }
    
    .message-content em {
        font-style: italic;
        color: #374151;
    }
    
    .message-content ul,
    .message-content ol {
        margin: 0.5em 0;
        padding-left: 1.5em;
    }
    
    .message-content li {
        margin: 0.25em 0;
    }
    
    .message-content p {
        margin: 0.5em 0;
    }
    
    .message-content p:first-child {
        margin-top: 0;
    }
    
    .message-content p:last-child {
        margin-bottom: 0;
    }
    
    .message-content code {
        background: #f3f4f6;
        padding: 0.125em 0.25em;
        border-radius: 3px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875em;
    }
    
    .message-content pre {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 1em;
        overflow-x: auto;
        margin: 0.5em 0;
    }
    
    .message-content pre code {
        background: none;
        padding: 0;
    }
    
    .message-content blockquote {
        border-left: 4px solid #e5e7eb;
        margin: 0.5em 0;
        padding-left: 1em;
        color: #6b7280;
        font-style: italic;
    }
    
    .message-content a {
        color: #3b82f6;
        text-decoration: underline;
    }
    
    .message-content a:hover {
        color: #1d4ed8;
    }
    
    /* 用户消息中的文本保持白色 */
    .message.user .message-content h1,
    .message.user .message-content h2,
    .message.user .message-content h3,
    .message.user .message-content h4,
    .message.user .message-content h5,
    .message.user .message-content h6,
    .message.user .message-content strong,
    .message.user .message-content p {
        color: white;
    }
    
    .message.user .message-content code {
        background: rgba(255,255,255,0.2);
        color: white;
    }
    
    .message.user .message-content pre {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .message.user .message-content blockquote {
        border-left-color: rgba(255,255,255,0.3);
        color: rgba(255,255,255,0.8);
    }
    
    /* 消息容器布局 */
    .message {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 20px;
        animation: slideIn 0.3s ease;
    }
    
    .message.user {
        flex-direction: row-reverse;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .message.user .message-avatar {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .message-time {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 8px;
        opacity: 0.7;
    }
    
    .message.user .message-time {
        color: rgba(255,255,255,0.7);
    }
    
    /* 其他现有样式保持不变... */
</style>
{% endblock %}

{% block content %}
<ol class="breadcrumb">
    <li class="breadcrumb-item">您的位置</li>
    <li class="breadcrumb-item active">
      <a href='{{url_for('dashboard.dashboard_application')}}'>应用程序</a>
    </li>
    <li class="breadcrumb-item active"> 
      <a href='{{url_for('dashboard.dashboard_kg')}}'>大模型与知识图谱</a>
    </li>
    <li class="breadcrumb-item active">大语言模型</li>
</ol>

<div class="chat-container">
    <!-- 顶部头部 -->
    <div class="chat-header">
        <div class="chat-title">
            <span>🏭</span>
            <span>工业智能AI助手</span>
        </div>
        <div class="chat-controls">
            <button class="conversations-toggle" onclick="toggleConversations()">
                <span>💬</span>
                <span>历史对话</span>
            </button>
            <button class="new-chat-btn" id="newChatBtn" onclick="createNewConversation()">
                <span>➕</span>
                <span>新建对话</span>
            </button>
        </div>
    </div>
    
    <!-- 主要内容区域 -->
    <div class="chat-main">
        <!-- 对话列表侧边栏 -->
        <div class="conversations-sidebar" id="conversationsSidebar">
            <div class="conversations-header">
                <input type="text" class="conversations-search" placeholder="搜索对话..." 
                       oninput="filterConversations(this.value)">
            </div>
            <div class="conversations-list" id="conversationsList">
                <!-- 对话列表将在这里动态生成 -->
            </div>
        </div>
        
        <!-- 遮罩层 -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleConversations()"></div>
        
        <!-- 聊天区域 -->
        <div class="chat-area">
            <div class="messages-container" id="messagesContainer">
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">🏭</div>
                    <div class="empty-state-title">欢迎使用工业智能AI助手</div>
                    <div class="empty-state-subtitle">
                        我是专注于工业领域的智能AI助手，可以为您提供制造业、自动化、设备维护等专业解答
                    </div>
                    <div class="welcome-features">
                        <div class="feature-card">
                            <div class="feature-icon">⚙️</div>
                            <div class="feature-title">设备维护</div>
                            <div class="feature-desc">提供设备故障诊断和维护建议</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">🤖</div>
                            <div class="feature-title">自动化方案</div>
                            <div class="feature-desc">协助设计和优化自动化流程</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">📊</div>
                            <div class="feature-title">工艺优化</div>
                            <div class="feature-desc">分析生产数据，优化工艺参数</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="输入您的工业技术问题，例如：如何提高生产线效率？"
                        rows="1"
                    ></textarea>
                    <!-- 在HTML中修改发送按钮 -->
                    <button id="sendBtn" class="send-btn" onclick="sendMessageStream()">
                        <span>↗</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentConversationId = null;
let conversations = [];
let isLoading = false;
let allConversations = [];
let currentStreamingMessage = null;
let useStreamMode = true;

// 初始化Markdown解析器
let md;
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 页面初始化开始...');
    
    // 初始化markdown-it
    if (typeof markdownit !== 'undefined') {
        md = markdownit({
            html: false,        // 禁用HTML标签
            xhtmlOut: false,    // 使用HTML格式
            breaks: true,       // 将换行符转换为<br>
            linkify: true,      // 自动识别链接
            typographer: true   // 启用智能引号和其他印刷符号
        });
        console.log('✅ Markdown解析器初始化完成');
    } else {
        console.warn('⚠️ Markdown解析器未加载，将使用纯文本显示');
    }
    
    loadConversations();
    setupInputHandler();
    setupScrollEvents();
});

// 渲染Markdown内容
function renderMarkdown(content) {
    if (!content) return '';
    
    // 如果markdown解析器可用，使用它渲染
    if (md) {
        try {
            return md.render(content);
        } catch (error) {
            console.warn('⚠️ Markdown渲染失败，使用纯文本:', error);
            return escapeHtml(content);
        }
    }
    
    // 如果没有markdown解析器，手动处理基本格式
    return processBasicMarkdown(content);
}

// 基本Markdown处理（备用方案）
function processBasicMarkdown(text) {
    if (!text) return '';
    
    // 转义HTML
    text = escapeHtml(text);
    
    // 处理粗体 **text**
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // 处理斜体 *text*
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // 处理代码 `code`
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // 处理换行
    text = text.replace(/\n/g, '<br>');
    
    // 处理标题 # ## ###
    text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
    text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
    text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');
    
    // 处理列表项 - item
    text = text.replace(/^- (.*$)/gm, '<li>$1</li>');
    text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
    
    return text;
}

// 更新流式消息内容（使用Markdown渲染）
function updateStreamingMessage(messageElement, content) {
    if (!messageElement) return;
    
    const contentDiv = messageElement.querySelector('.streaming-content');
    if (contentDiv) {
        // 使用Markdown渲染
        contentDiv.innerHTML = renderMarkdown(content);
        
        // 如果用户在底部，继续滚动
        if (isScrolledToBottom()) {
            scrollToBottom();
        }
    }
}

// 修改添加消息函数（使用Markdown渲染）
function addMessage(role, content) {
    const container = document.getElementById('messagesContainer');
    if (!container) {
        console.error('❌ 消息容器未找到');
        return;
    }
    
    // 检查用户是否在底部
    const shouldAutoScroll = isScrolledToBottom();
    
    // 确保移除空状态
    const emptyState = container.querySelector('#emptyState');
    if (emptyState) {
        emptyState.remove();
    }
    
    const time = new Date().toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    messageDiv.innerHTML = `
        <div class="message-avatar">
            ${role === 'user' ? '👤' : '🏭'}
        </div>
        <div class="message-content">
            ${renderMarkdown(content)}
            <div class="message-time">${time}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    
    // 只有当用户在底部时才自动滚动
    if (shouldAutoScroll) {
        scrollToBottom();
    }
}

// 修改渲染消息列表函数（使用Markdown渲染）
function renderMessages(messages) {
    const container = document.getElementById('messagesContainer');
    if (!container) {
        console.error('❌ 消息容器未找到');
        return;
    }
    
    if (!messages || messages.length === 0) {
        initializeEmptyChat();
        return;
    }
    
    // 记录当前滚动位置
    const scrollTop = container.scrollTop;
    const isAtBottom = isScrolledToBottom();
    
    // 清空容器并渲染消息
    container.innerHTML = messages.map(msg => {
        const time = new Date().toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        return `
            <div class="message ${msg.role}">
                <div class="message-avatar">
                    ${msg.role === 'user' ? '👤' : '🏭'}
                </div>
                <div class="message-content">
                    ${renderMarkdown(msg.content || '')}
                    <div class="message-time">${time}</div>
                </div>
            </div>
        `;
    }).join('');
    
    // 恢复滚动位置或滚动到底部
    requestAnimationFrame(() => {
        if (isAtBottom || messages.length <= 2) {
            // 如果之前在底部或消息很少，滚动到底部
            scrollToBottom();
        } else {
            // 否则恢复之前的位置
            container.scrollTop = scrollTop;
        }
    });
    
    console.log(`✅ 渲染了 ${messages.length} 条消息`);
}

// 其他函数保持不变...
// （这里省略其他已有的函数代码，保持原有逻辑不变）

// 设置输入框事件
function setupInputHandler() {
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    
    if (!input || !sendBtn) {
        console.error('❌ 输入框或发送按钮未找到');
        return;
    }
    
    // 自动调整高度
    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        
        // 更新发送按钮状态
        updateButtonStates();
    });
    
    // 回车发送
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!isLoading && this.value.trim()) {
                if (useStreamMode) {
                    sendMessageStream();
                } else {
                    sendMessage();
                }
            }
        }
    });
    
    // 初始状态
    updateButtonStates();
    console.log('✅ 输入框事件设置完成');
}

// 流式发送消息
async function sendMessageStream() {
    const input = document.getElementById('messageInput');
    const message = input ? input.value.trim() : '';
    
    if (!message || isLoading) return;
    
    try {
        console.log(`💬 发送流式消息: ${message.substring(0, 50)}...`);
        
        // 如果没有当前对话，创建一个
        if (!currentConversationId) {
            console.log('🆕 没有当前对话，创建新对话...');
            await createNewConversation();
            if (!currentConversationId) {
                throw new Error('无法创建对话');
            }
        }
        
        isLoading = true;
        updateButtonStates();
        
        // 清空输入框
        input.value = '';
        input.style.height = 'auto';
        
        // 确保消息容器准备好
        ensureMessageContainer();
        
        // 添加用户消息
        addMessage('user', message);
        
        // 创建AI消息容器（空内容，用于流式填充）
        const aiMessageElement = createStreamingMessage();
        
        try {
            const response = await fetch('/llm/chat/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    chat_id: currentConversationId
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
                const { done, value } = await reader.read();
                
                if (done) {
                    console.log('✅ 流式响应完成');
                    break;
                }
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const jsonStr = line.slice(6);
                            // 检查是否为空或无效数据
                            if (!jsonStr.trim()) continue;
                            
                            const data = JSON.parse(jsonStr);
                            handleStreamData(data, aiMessageElement);
                        } catch (e) {
                            console.warn('⚠️ 解析流数据失败:', e);
                            console.warn('原始数据:', line);
                            
                            // 尝试修复常见的JSON问题
                            try {
                                const jsonStr = line.slice(6);
                                // 移除可能的控制字符
                                const cleanedStr = jsonStr.replace(/[\x00-\x1F\x7F]/g, '');
                                const data = JSON.parse(cleanedStr);
                                handleStreamData(data, aiMessageElement);
                            } catch (retryError) {
                                console.warn('⚠️ 重试解析也失败，跳过此数据块');
                                // 如果仍然失败，尝试提取内容
                                if (line.includes('"content"')) {
                                    const contentMatch = line.match(/"content":\s*"([^"]*?)"/);
                                    if (contentMatch) {
                                        handleStreamData({
                                            type: 'content',
                                            content: contentMatch[1]
                                        }, aiMessageElement);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // 更新对话列表
            await loadConversations();
            
        } catch (fetchError) {
            console.error('❌ 流式请求失败:', fetchError);
            updateStreamingMessage(aiMessageElement, '网络错误，请检查连接后重试：' + fetchError.message);
        }
        
    } catch (error) {
        console.error('❌ 发送流式消息失败:', error);
        if (currentStreamingMessage) {
            updateStreamingMessage(currentStreamingMessage, '发送消息失败：' + error.message);
        }
    } finally {
        currentStreamingMessage = null;
        isLoading = false;
        updateButtonStates();
        
        // 重新聚焦输入框
        if (input) input.focus();
    }
}

// 创建流式消息元素
function createStreamingMessage() {
    const container = document.getElementById('messagesContainer');
    if (!container) {
        console.error('❌ 消息容器未找到');
        return null;
    }
    
    // 检查用户是否在底部
    const shouldAutoScroll = isScrolledToBottom();
    
    const time = new Date().toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message assistant streaming';
    messageDiv.innerHTML = `
        <div class="message-avatar">🏭</div>
        <div class="message-content">
            <div class="streaming-content"></div>
            <div class="message-time">${time}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    currentStreamingMessage = messageDiv;
    
    // 只有当用户在底部时才自动滚动
    if (shouldAutoScroll) {
        scrollToBottom();
    }
    
    return messageDiv;
}

// 更新流式消息内容
function updateStreamingMessage(messageElement, content) {
    if (!messageElement) return;
    
    const contentDiv = messageElement.querySelector('.streaming-content');
    if (contentDiv) {
        contentDiv.innerHTML = escapeHtml(content);
        
        // 如果用户在底部，继续滚动
        if (isScrolledToBottom()) {
            scrollToBottom();
        }
    }
}

// 处理流式数据
function handleStreamData(data, messageElement) {
    console.log('📊 流式数据:', data.type);
    
    switch (data.type) {
        case 'start':
            console.log('🚀 开始接收流式响应');
            // 可以显示"正在思考..."的状态
            break;
            
        case 'content':
            // 更新消息内容
            updateStreamingMessage(messageElement, data.content);
            break;
            
        case 'done':
            console.log('✅ 流式响应完成');
            // 移除流式样式
            if (messageElement) {
                messageElement.classList.remove('streaming');
            }
            break;
            
        case 'error':
            console.error('❌ 流式响应错误:', data.content);
            updateStreamingMessage(messageElement, data.content);
            if (messageElement) {
                messageElement.classList.remove('streaming');
                messageElement.classList.add('error');
            }
            break;
    }
}

// 修改原有的发送消息函数（现在调用流式版本）
async function sendMessage() {
    if (useStreamMode) {
        return sendMessageStream();
    }
    
    // 原有的非流式版本
    const input = document.getElementById('messageInput');
    const message = input ? input.value.trim() : '';
    
    if (!message || isLoading) return;
    
    try {
        console.log(`💬 发送消息: ${message.substring(0, 50)}...`);
        
        // 如果没有当前对话，创建一个
        if (!currentConversationId) {
            console.log('🆕 没有当前对话，创建新对话...');
            await createNewConversation();
            if (!currentConversationId) {
                throw new Error('无法创建对话');
            }
        }
        
        isLoading = true;
        updateButtonStates();
        
        // 清空输入框
        input.value = '';
        input.style.height = 'auto';
        
        // 确保消息容器准备好
        ensureMessageContainer();
        
        // 添加用户消息
        addMessage('user', message);
        
        // 显示输入指示器
        showTypingIndicator();
        
        const response = await fetch('/llm/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                chat_id: currentConversationId
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('📊 聊天响应:', data.success);
        
        if (data.success) {
            // 添加AI回复
            addMessage('assistant', data.response || '抱歉，我没有生成回复。');
            
            // 更新对话列表
            await loadConversations();
        } else {
            addMessage('assistant', '抱歉，出现了错误：' + (data.message || '未知错误'));
        }
    } catch (error) {
        console.error('❌ 发送消息失败:', error);
        addMessage('assistant', '网络错误，请检查连接后重试：' + error.message);
    } finally {
        hideTypingIndicator();
        isLoading = false;
        updateButtonStates();
        
        // 重新聚焦输入框
        if (input) input.focus();
    }
}

// 其他函数保持不变...
// （保留所有之前的函数：toggleConversations, filterConversations, updateButtonStates, 
//  showError, scrollToBottom, setupScrollEvents, loadConversations, renderConversations,
//  escapeHtml, createNewConversation, selectConversation, deleteConversation,
//  ensureMessageContainer, initializeEmptyChat, renderMessages, addMessage,
//  showTypingIndicator, hideTypingIndicator, addScrollToBottomButton 等）

// 切换对话列表显示
function toggleConversations() {
    const sidebar = document.getElementById('conversationsSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    if (sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
        overlay.classList.remove('show');
    } else {
        sidebar.classList.add('open');
        overlay.classList.add('show');
    }
}

// 搜索对话
function filterConversations(query) {
    if (!query.trim()) {
        conversations = [...allConversations];
    } else {
        conversations = allConversations.filter(conv => 
            conv.title.toLowerCase().includes(query.toLowerCase()) ||
            conv.last_message.toLowerCase().includes(query.toLowerCase())
        );
    }
    renderConversations();
}

// 更新按钮状态
function updateButtonStates() {
    const sendBtn = document.getElementById('sendBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const input = document.getElementById('messageInput');
    
    if (sendBtn) {
        const hasText = input ? input.value.trim().length > 0 : false;
        sendBtn.disabled = !hasText || isLoading;
    }
    
    if (newChatBtn) {
        newChatBtn.disabled = isLoading;
    }
}

// 显示错误消息
function showError(message) {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    // 确保移除空状态
    const emptyState = container.querySelector('#emptyState');
    if (emptyState) {
        emptyState.remove();
    }
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    
    container.appendChild(errorDiv);
    scrollToBottom();
    
    // 5秒后自动移除错误消息
    setTimeout(() => {
        if (errorDiv && errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
        }
    }, 5000);
}

// 滚动到底部
function scrollToBottom() {
    const container = document.getElementById('messagesContainer');
    if (container) {
        // 使用 requestAnimationFrame 确保在DOM更新后执行
        requestAnimationFrame(() => {
            container.scrollTop = container.scrollHeight;
        });
    }
}

// 改进的滚动函数，支持平滑滚动到底部
function smoothScrollToBottom() {
    const container = document.getElementById('messagesContainer');
    if (container) {
        container.scrollTo({
            top: container.scrollHeight,
            behavior: 'smooth'
        });
    }
}

// 添加自动滚动检测函数
function isScrolledToBottom() {
    const container = document.getElementById('messagesContainer');
    if (!container) return true;
    
    const threshold = 50; // 50px的阈值
    return container.scrollTop + container.clientHeight >= container.scrollHeight - threshold;
}

// 设置滚动事件
function setupScrollEvents() {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    // 添加滚动事件监听
    let scrollTimeout;
    container.addEventListener('scroll', function() {
        // 防抖处理
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
            // 可以在这里添加滚动到顶部加载更多消息的逻辑
            if (container.scrollTop === 0) {
                console.log('📜 滚动到顶部，可以加载更多历史消息');
            }
        }, 150);
    });
    
    console.log('✅ 滚动事件设置完成');
}

// 加载对话列表
async function loadConversations() {
    try {
        console.log('📋 开始加载对话列表...');
        const response = await fetch('/llm/conversations');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('📊 对话列表数据:', data);
        
        if (data.success) {
            allConversations = data.conversations || [];
            conversations = [...allConversations];
            renderConversations();
            
            // 如果没有对话，创建一个新的
            if (conversations.length === 0) {
                console.log('📝 没有对话，创建新对话...');
                await createNewConversation();
            } else {
                // 选择第一个对话
                console.log('🎯 选择第一个对话...');
                selectConversation(conversations[0].chat_id);
            }
        } else {
            throw new Error(data.message || '获取对话列表失败');
        }
    } catch (error) {
        console.error('❌ 加载对话列表失败:', error);
        showError('加载对话列表失败：' + error.message);
    }
}

// 渲染对话列表
function renderConversations() {
    const container = document.getElementById('conversationsList');
    
    if (!container) {
        console.error('❌ 对话列表容器未找到');
        return;
    }
    
    if (conversations.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;">暂无对话</div>';
        return;
    }
    
    container.innerHTML = conversations.map(conv => {
        const date = new Date(conv.created_at).toLocaleDateString('zh-CN', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        return `
            <div class="conversation-item ${conv.chat_id === currentConversationId ? 'active' : ''}" 
                 onclick="selectConversation('${conv.chat_id}')">
                <div class="conversation-content">
                    <div class="conversation-title">${escapeHtml(conv.title || '新对话')}</div>
                    <div class="conversation-preview">${escapeHtml(conv.last_message || '暂无消息')}</div>
                    <div class="conversation-date">${date}</div>
                </div>
                <div class="conversation-actions">
                    <button class="delete-btn" onclick="deleteConversation('${conv.chat_id}', event)" title="删除对话">×</button>
                </div>
            </div>
        `;
    }).join('');
    
    console.log(`✅ 渲染了 ${conversations.length} 个对话`);
}

// HTML转义函数
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 创建新对话
async function createNewConversation() {
    if (isLoading) return;
    
    try {
        console.log('🆕 开始创建新对话...');
        isLoading = true;
        updateButtonStates();
        
        const response = await fetch('/llm/conversations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('📊 创建对话响应:', data);
        
        if (data.success) {
            currentConversationId = data.chat_id;
            console.log(`✅ 新对话创建成功: ${currentConversationId}`);
            
            await loadConversations();
            initializeEmptyChat();
            
            // 关闭侧边栏并聚焦输入框
            const sidebar = document.getElementById('conversationsSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            
            const input = document.getElementById('messageInput');
            if (input) input.focus();
        } else {
            throw new Error(data.message || '创建对话失败');
        }
    } catch (error) {
        console.error('❌ 创建对话失败:', error);
        showError('创建对话失败：' + error.message);
    } finally {
        isLoading = false;
        updateButtonStates();
    }
}

// 选择对话
async function selectConversation(chatId) {
    if (chatId === currentConversationId || isLoading) return;
    
    try {
        console.log(`🎯 选择对话: ${chatId}`);
        currentConversationId = chatId;
        renderConversations(); // 更新选中状态
        
        // 关闭侧边栏
        const sidebar = document.getElementById('conversationsSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.remove('open');
        overlay.classList.remove('show');
        
        const response = await fetch(`/llm/conversations/${chatId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('📊 对话详情:', data);
        
        if (data.success) {
            renderMessages(data.messages || []);
        } else {
            throw new Error(data.message || '获取对话详情失败');
        }
    } catch (error) {
        console.error('❌ 选择对话失败:', error);
        showError('加载对话失败：' + error.message);
    }
}

// 删除对话
async function deleteConversation(chatId, event) {
    event.stopPropagation();
    
    if (!confirm('确定要删除这个对话吗？') || isLoading) return;
    
    try {
        console.log(`🗑️ 删除对话: ${chatId}`);
        
        const response = await fetch(`/llm/conversations/${chatId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('✅ 对话删除成功');
            
            if (chatId === currentConversationId) {
                currentConversationId = null;
                initializeEmptyChat();
            }
            
            await loadConversations();
        } else {
            throw new Error(data.message || '删除对话失败');
        }
    } catch (error) {
        console.error('❌ 删除对话失败:', error);
        showError('删除对话失败：' + error.message);
    }
}

// 确保消息容器存在且正确初始化
function ensureMessageContainer() {
    const container = document.getElementById('messagesContainer');
    if (!container) {
        console.error('❌ 消息容器未找到');
        return;
    }
    
    // 如果容器中有空状态，移除它
    const emptyState = container.querySelector('#emptyState');
    if (emptyState) {
        emptyState.style.display = 'none';
    }
}

// 初始化空的聊天状态
function initializeEmptyChat() {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    // 清空容器并重新添加空状态
    container.innerHTML = `
        <div class="empty-state" id="emptyState">
            <div class="empty-state-icon">🏭</div>
            <div class="empty-state-title">欢迎使用工业智能AI助手</div>
            <div class="empty-state-subtitle">
                我是专注于工业领域的智能AI助手，可以为您提供制造业、自动化、设备维护等专业解答
            </div>
            <div class="welcome-features">
                <div class="feature-card">
                    <div class="feature-icon">⚙️</div>
                    <div class="feature-title">设备维护</div>
                    <div class="feature-desc">提供设备故障诊断和维护建议</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🤖</div>
                    <div class="feature-title">自动化方案</div>
                    <div class="feature-desc">协助设计和优化自动化流程</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">📊</div>
                    <div class="feature-title">工艺优化</div>
                    <div class="feature-desc">分析生产数据，优化工艺参数</div>
                </div>
            </div>
        </div>
    `;
}

// 渲染消息列表
function renderMessages(messages) {
    const container = document.getElementById('messagesContainer');
    if (!container) {
        console.error('❌ 消息容器未找到');
        return;
    }
    
    if (!messages || messages.length === 0) {
        initializeEmptyChat();
        return;
    }
    
    // 记录当前滚动位置
    const scrollTop = container.scrollTop;
    const isAtBottom = isScrolledToBottom();
    
    // 清空容器并渲染消息
    container.innerHTML = messages.map(msg => {
        const time = new Date().toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        return `
            <div class="message ${msg.role}">
                <div class="message-avatar">
                    ${msg.role === 'user' ? '👤' : '🏭'}
                </div>
                <div class="message-content">
                    ${renderMarkdown(msg.content || '')}
                    <div class="message-time">${time}</div>
                </div>
            </div>
        `;
    }).join('');
    
    // 恢复滚动位置或滚动到底部
    requestAnimationFrame(() => {
        if (isAtBottom || messages.length <= 2) {
            // 如果之前在底部或消息很少，滚动到底部
            scrollToBottom();
        } else {
            // 否则恢复之前的位置
            container.scrollTop = scrollTop;
        }
    });
    
    console.log(`✅ 渲染了 ${messages.length} 条消息`);
}

// 添加消息
function addMessage(role, content) {
    const container = document.getElementById('messagesContainer');
    if (!container) {
        console.error('❌ 消息容器未找到');
        return;
    }
    
    // 检查用户是否在底部
    const shouldAutoScroll = isScrolledToBottom();
    
    // 确保移除空状态
    const emptyState = container.querySelector('#emptyState');
    if (emptyState) {
        emptyState.remove();
    }
    
    const time = new Date().toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    messageDiv.innerHTML = `
        <div class="message-avatar">
            ${role === 'user' ? '👤' : '🏭'}
        </div>
        <div class="message-content">
            ${renderMarkdown(content)}
            <div class="message-time">${time}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    
    // 只有当用户在底部时才自动滚动
    if (shouldAutoScroll) {
        scrollToBottom();
    }
}

// 显示/隐藏输入指示器
function showTypingIndicator() {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    // 检查是否需要自动滚动
    const shouldAutoScroll = isScrolledToBottom();
    
    // 移除已存在的指示器
    hideTypingIndicator();
    
    const indicator = document.createElement('div');
    indicator.className = 'typing-indicator';
    indicator.id = 'typingIndicator';
    indicator.innerHTML = `
        <div class="message-avatar">🏭</div>
        <div class="typing-content">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    `;
    container.appendChild(indicator);
    
    // 只有在底部时才滚动
    if (shouldAutoScroll) {
        smoothScrollToBottom();
    }
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator && indicator.parentNode) {
        indicator.parentNode.removeChild(indicator);
    }
}

// 添加快速滚动到底部的按钮（可选）
function addScrollToBottomButton() {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    // 创建滚动到底部按钮
    const scrollBtn = document.createElement('button');
    scrollBtn.className = 'scroll-to-bottom-btn';
    scrollBtn.innerHTML = '↓';
    scrollBtn.title = '滚动到底部';
    scrollBtn.onclick = smoothScrollToBottom;
    
    // 添加到消息容器的父元素
    const chatArea = container.parentElement;
    if (chatArea) {
        chatArea.appendChild(scrollBtn);
    }
    
    // 根据滚动位置显示/隐藏按钮
    container.addEventListener('scroll', function() {
        if (isScrolledToBottom()) {
            scrollBtn.style.display = 'none';
        } else {
            scrollBtn.style.display = 'flex';
        }
    });
}

// 添加滚动按钮相关CSS和功能
const additionalCSS = `
    .scroll-to-bottom-btn {
        position: absolute;
        bottom: 100px;
        right: 30px;
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: all 0.2s;
        z-index: 20;
    }
    
    .scroll-to-bottom-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    
    .chat-area {
        position: relative;
    }
    
    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.3);
        z-index: 5;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .sidebar-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    
    /* 流式消息样式 */
    .message.streaming .message-content {
        position: relative;
    }
    
    .message.streaming .streaming-content::after {
        content: '▊';
        animation: blink 1s infinite;
        color: #667eea;
        margin-left: 2px;
    }
    
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
    }
    
    .message.error .message-content {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-color: #f87171;
        color: #dc2626;
    }
`;

// 动态添加CSS
const style = document.createElement('style');
style.textContent = additionalCSS;
document.head.appendChild(style);

// 在初始化时添加滚动按钮
setTimeout(() => {
    addScrollToBottomButton();
}, 1000);
</script>
{% endblock %}